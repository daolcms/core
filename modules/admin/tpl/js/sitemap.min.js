jQuery(function(e){function r(e,t){var n=0,r=0;while(e&&e!=t){n+=e.offsetTop;r+=e.offsetLeft;e=e.offsetParent}return{top:n,left:r}}function i(e,t){if(Math.abs(e.top-t)<=3){n.css({top:e.top-3,height:"5px"});return"before"}else if(Math.abs(e.bottom-t)<=3){n.css({top:e.bottom-3,height:"5px"});return"after"}else{n.css({top:e.top+3,height:"27px"});return"prepend"}}var t=false,n=e('<li class="placeholder">');e("form.siteMap").delegate("li:not(.placeholder)",{"mousedown.st":function(s){var o,u,a,f,l,c,h,p,d,v,m="";if(e(s.target).is("a,input,label,textarea")||s.which!=1)return;t=true;o=e(this);l=o.height();f=o.width();u=o.parentsUntil(".siteMap").filter("ul");a=u.eq(-1);a.css("position","relative");h={x:s.pageX,y:s.pageY};c=r(this,a.get(0));$clone=o.clone(true).attr("target",true);for(d=u.length-1;d;d--){$clone=$clone.wrap("<li><ul /></li>").parent().parent()}p=[];a.find("li").each(function(e){if(o[0]===this||o.has(this).length)return true;var t=r(this,a.get(0));p.push({top:t.top,bottom:t.top+32,item:this})});$clone.find(".side,input").remove().end().addClass("draggable").css({position:"absolute",opacity:.6,width:f,height:l,left:c.left,top:c.top,zIndex:100}).appendTo(a.eq(0));n.css({position:"absolute",opacity:.6,width:f,height:"5px",left:c.left,top:c.top,zIndex:99}).appendTo(a.eq(0));o.css("opacity",.6);e(document).unbind("mousemove.st mouseup.st").bind("mousemove.st",function(e){var t,n,r,s,o,u,a;v=null;t={x:h.x-e.pageX,y:h.y-e.pageY};n=c.top-t.y;for(s=0,o=p.length;s<o;s++){a=n;u=p[s];if(s==0&&a<u.top)a=u.top;if(s==o-1&&a>u.bottom)a=u.bottom;if(u.top<=a&&u.bottom>=a){v={element:u.item,state:i(u,a)};break}}$clone.css({top:n})}).bind("mouseup.st",function(r){var i,s;t=false;e(document).unbind("mousemove.st mouseup.st");o.css("opacity","");$clone.remove();n.remove();s=e("<li />").height(o.height());if(!v)return;i=e(v.element);o.before(s);if(v.state=="prepend"){if(!i.find(">ul").length)i.find(">.side").after("<ul>");i.find(">ul").prepend(o.hide())}else{i[v.state](o.hide())}o.slideDown(100,function(){o.removeClass("active")});s.slideUp(100,function(){var e=s.parent();s.remove();if(!e.children("li").length)e.remove()});o.trigger("dropped.st")});return false},"mouseover.st":function(){if(!t)e(this).addClass("active");return false},"mouseout.st":function(){if(!t)e(this).removeClass("active");return false}}).find("li").prepend('<button type="button" class="moveTo">Move to</button>').append('<span class="vr"></span><span class="hr"></span>').find("input:text").focus(function(){var t=e(this),n=t.prev("label"),r=t.parent();t.width(r.width()-(parseInt(r.css("text-indent"))||0)-t.next(".side").width()-60).css("opacity","");n.hide()}).blur(function(){var t=e(this),n=t.prev("label"),r=t.val();t.width(0).css("opacity",0);n.removeClass("no-text").empty().text(r).show();if(!r)n.addClass("no-text").text("---")}).each(function(t,n){var r=e(this),i="sitemap-id-"+t;r.attr("id",i).css({width:0,opacity:0,overflow:"hidden"}).before("<label />").prev("label").attr("for",i).text(r.val())}).end().end()})