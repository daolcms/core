!function(e){"use strict";var t={autoUpload:!0,dataType:"json",sequentialUploads:!0,dropZone:".xefu-dropzone",fileList:".xefu-list",controll:".xefu-controll",filelist:".xefu-list-files ul",filelistImages:".xefu-list-images ul",progressbar:".xefu-progressbar",progressbarGraph:".xefu-progressbar div",progressStatus:".xefu-progress-status",progressPercent:".xefu-progress-percent",actSelectedInsertContent:".xefu-act-link-selected",actSelectedDeleteFile:".xefu-act-delete-selected",actDeleteFile:".xefu-act-delete",tmplXeUploaderFileitem:'<li class="xefu-file xe-clearfix" data-file-srl="{{file_srl}}"><span class="xefu-file-name">{{source_filename}}</span><span class="xefu-file-info"><span>{{disp_file_size}}</span><span><input type="checkbox" data-file-srl="{{file_srl}}"> 선택</span></span></li>',tmplXeUploaderFileitemImage:'<li class="xefu-file xefu-file-image" data-file-srl="{{file_srl}}"><strong class="xefu-file-name">{{source_filename}}</strong><span class="xefu-file-info"><span class="xefu-file-size">{{disp_file_size}}</span><span><img src="{{download_url}}" alt=""></span><span><input type="checkbox" data-file-srl="{{file_srl}}"></span></span></li>'},i=["fileList","actSelectedInsertContent","actSelectedDeleteFile","actDeleteFile","controll","dropZone","filelist","filelistImages","progressbar","progressbarGraph","progressPercent","progressStatus"],s=xe.createApp("XeUploader",{files:{},selected_files:{},settings:{},last_selected_file:null,editor_sequence:null,init:function(){},createInstance:function(s,l){var n=this,r=this.$container=s,a=r.data();this.editor_sequence=a.editorSequence;var o={url:request_uri.setQuery("module","file").setQuery("act","procFileUpload"),formData:{editor_sequence:a.editorSequence,upload_target_srl:a.uploadTargetSrl,mid:window.current_mid},dropZone:r,add:function(t,i){var s=jQuery.Deferred();e.each(i.files,function(e,t){return n.settings.maxFileSize<=t.size?(s.reject(),alert(window.xe.msg_exceeds_limit_size),!1):void s.resolve()}),s.done(function(){i.submit()})},done:function(e,t){var i=t.response().result;i&&(jQuery.isPlainObject(i)||(i=jQuery.parseJSON(i)),i&&(0==i.error||alert(i.message)))},stop:function(){n.loadFilelist()},start:function(){n.settings.progressbarGraph.width(0),n.settings.progressStatus.show(),n.settings.progressbar.show()},progressall:function(e,t){var i=parseInt(t.loaded/t.total*100,10);n.settings.progressbarGraph.width(i+"%"),n.settings.progressPercent.text(i+"%"),i>=100&&(n.settings.progressbar.delay(3e3).slideUp(),n.settings.progressStatus.delay(3e3).slideUp())}};this.settings=e.extend({},t,o,l||{}),e.each(i,function(e,t){"string"==typeof n.settings[t]&&(n.settings[t]=r.find(n.settings[t]))});r.fileupload(this.settings).prop("disabled",!e.support.fileInput).parent().addClass(e.support.fileInput?void 0:"disabled");r.data("xefu-instance",this),this.loadFilelist(),this.settings.actSelectedInsertContent.on("click",function(){n.insertToContent()}),this.settings.actSelectedDeleteFile.on("click",function(){n.deleteFile()});var d=this.settings.fileList.finderSelect({children:"li"});this.settings.fileList.on("mousedown","img",function(e){e.preventDefault()}),d.finderSelect("addHook","highlight:after",function(e){e.find("input").prop("checked",!0);var t=n.settings.fileList.find("input:checked");n.selected_files=t}),d.finderSelect("addHook","unHighlight:after",function(e){e.find("input").prop("checked",!1);var t=n.settings.fileList.find("input:checked");n.selected_files=t}),d.on("click",":checkbox",function(e){e.preventDefault()}),e(document).bind("dragover",function(e){var t=window.dropZoneTimeout,i=n.settings.dropZone;t?clearTimeout(t):i.addClass("in");var s=!1,l=e.target;do{if(l===i[0]){s=!0;break}l=l.parentNode}while(null!=l);s?i.addClass("hover"):i.removeClass("hover"),window.dropZoneTimeout=setTimeout(function(){window.dropZoneTimeout=null,i.removeClass("in hover")},100)})},done:function(){},selectAllFiles:function(){},selectImageFiles:function(){},selectNonImageFiles:function(){},unselectAllFiles:function(){},unselectImageFiles:function(){},unselectNonImageFiles:function(){},insertToContent:function(){var t=this,i="";e.each(this.selected_files,function(s,l){var n=e(l).data().fileSrl,r=t.files[n];r&&(/\.(jpe?g|png|gif)$/i.test(r.download_url)?(i+='<img src="'+window.request_uri+r.download_url+'" alt="'+r.source_filename+'" editor_component="image_link" data-file-srl="'+r.file_srl+'" />',i+="\r\n<p><br></p>\r\n"):i+='<a href="'+window.request_uri+r.download_url+'" data-file-srl="'+r.file_srl+'">'+r.source_filename+"</a>\n")}),_getCkeInstance(this.editor_sequence).insertHtml(i,"unfiltered_html")},deleteFile:function(t){var i=this,s=[];t?s.push(t):e.each(i.selected_files,function(t,i){if(i){var l=e(i).data().fileSrl;s.push(l)}}),s=s.join(","),exec_json("file.procFileDelete",{file_srls:s,editor_sequence:this.editor_sequence},function(){s=s.split(","),e.each(s,function(e,t){i.settings.fileList.find("ul").find("li[data-file-srl="+t+"]").remove()}),i.loadFilelist()})},loadFilelist:function(){var t=this,i=this.$container.data(),s={};s.mid=window.current_mid,s.editor_sequence=t.$container.data("editor-sequence"),e.exec_json("file.getFileList",s,function(s){i.uploadTargetSrl=s.upload_target_srl,editorRelKeys[t.$container.data("editor-sequence")].primary.value=s.upload_target_srl,i.uploadTargetSrl=s.uploadTargetSrl,e(".allowed_filetypes").text(s.allowed_filetypes),e(".allowed_filesize").text(s.allowed_filesize),e(".allowed_attach_size").text(s.allowed_attach_size),e(".attached_size").text(s.attached_size),e(".file_count").text(s.files.length);var l=t.settings.tmplXeUploaderFileitem,n=t.settings.tmplXeUploaderFileitemImage,r=Handlebars.compile(l),a=Handlebars.compile(n),o=[],d=[];return s.files.length?(e.each(s.files,function(e,i){t.files[i.file_srl]||(t.files[i.file_srl]=i,/\.(jpe?g|png|gif)$/i.test(i.source_filename)?o.push(a(i)):d.push(r(i)))}),t.settings.filelistImages.append(o.join("")),t.settings.filelist.append(d.join("")),t.settings.controll.show(),void t.settings.fileList.show()):(t.settings.fileList.hide(),void t.settings.controll.hide())})}});e.fn.xeUploader=function(e){var t=new s;return t&&(xe.registerApp(t),t.createInstance(this.eq(0),e)),t}}(jQuery);